name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Get version from tag
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        run: |
          PREVIOUS_TAG=$(git describe --abbrev=0 --tags $(git rev-list --tags --skip=1 --max-count=1) 2>/dev/null || echo "")
          if [ -z "$PREVIOUS_TAG" ]; then
            CHANGELOG=$(git log --pretty=format:"- %s" $GITHUB_SHA)
          else
            CHANGELOG=$(git log --pretty=format:"- %s" $PREVIOUS_TAG..$GITHUB_SHA)
          fi
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          name: Release v${{ steps.version.outputs.version }}
          body: |
            ## AxonTask v${{ steps.version.outputs.version }}

            ### Changes

            ${{ steps.changelog.outputs.changelog }}

            ### Installation

            See [SETUP.md](https://github.com/TheMailmans/AxonTask/blob/main/SETUP.md) for installation instructions.

            ### Documentation

            - [ROADMAP.md](https://github.com/TheMailmans/AxonTask/blob/main/ROADMAP.md)
            - [CLAUDE.md](https://github.com/TheMailmans/AxonTask/blob/main/CLAUDE.md)
            - [API_DESIGN.md](https://github.com/TheMailmans/AxonTask/blob/main/API_DESIGN.md)

            ### Commercial Licensing

            For commercial use, see [COMMERCIAL_LICENSE.md](https://github.com/TheMailmans/AxonTask/blob/main/COMMERCIAL_LICENSE.md).

          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-binaries:
    name: Build Release Binaries
    needs: create-release
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            name: linux-amd64
          - os: macos-latest
            target: x86_64-apple-darwin
            name: macos-amd64
          - os: macos-latest
            target: aarch64-apple-darwin
            name: macos-arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Build release binary
        run: cargo build --release --target ${{ matrix.target }}

      - name: Package binary
        run: |
          cd target/${{ matrix.target }}/release
          tar czf axontask-${{ matrix.name }}.tar.gz axontask-api axontask-worker 2>/dev/null || echo "Binaries not yet available"
          cd -

      - name: Upload binary to release
        uses: softprops/action-gh-release@v1
        with:
          files: target/${{ matrix.target }}/release/axontask-${{ matrix.name }}.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-docker:
    name: Publish Docker Images
    needs: create-release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Build and push API image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.api
          push: true
          tags: |
            ghcr.io/themailmans/axontask-api:latest
            ghcr.io/themailmans/axontask-api:${{ steps.version.outputs.version }}
          cache-from: type=registry,ref=ghcr.io/themailmans/axontask-api:buildcache
          cache-to: type=registry,ref=ghcr.io/themailmans/axontask-api:buildcache,mode=max

      - name: Build and push Worker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.worker
          push: true
          tags: |
            ghcr.io/themailmans/axontask-worker:latest
            ghcr.io/themailmans/axontask-worker:${{ steps.version.outputs.version }}
          cache-from: type=registry,ref=ghcr.io/themailmans/axontask-worker:buildcache
          cache-to: type=registry,ref=ghcr.io/themailmans/axontask-worker:buildcache,mode=max
